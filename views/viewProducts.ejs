<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Font Awesome for Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Link to the custom CSS file -->
  <link rel="stylesheet" href="/css/viewProducts.css">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <i class="fas fa-chart-line"></i>
      <span>Stocks List</span>
    </div>
    <div class="sidebar-nav">
      <!-- Dashboard Section -->
      <div class="sidebar-section">
        <div class="sidebar-heading">Dashboard</div>
        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a href="/" class="sidebar-link">
              <i class="fas fa-home"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="/sales" class="sidebar-link">
              <i class="fas fa-shopping-cart"></i>
              <span>Sales Report</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="/profit" class="sidebar-link">
              <i class="fas fa-chart-bar"></i>
              <span>Profit Report</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="/expense" class="sidebar-link">
              <i class="fas fa-money-bill-wave"></i>
              <span>Expenses</span>
            </a>
          </li>
        </ul>
      </div>
      
      <!-- Products Section -->
      <div class="sidebar-section">
        <div class="sidebar-heading">Products</div>
        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a href="/add-product" class="sidebar-link">
              <i class="fas fa-plus-circle"></i>
              <span>Add New Product</span>
            </a>
          </li>
        </ul>
      </div>
      
      <!-- Settings Section -->
      <div class="sidebar-section">
        <div class="sidebar-heading">Settings</div>
        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a href="/profile" class="sidebar-link">
              <i class="fas fa-user"></i>
              <span>Profile</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="sidebar-footer">
      <a href="/logout">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </a>
    </div>
  </div>
  
  <!-- Main Content Area -->
  <div class="main-content" id="main-content">
    <!-- Page Container -->
    <div class="page-container">
      <!-- Combined Filter Form: Category & Stock Threshold -->
      <div class="filter-container">
        <form method="GET" action="/view-products">
          <div class="filter-controls">
            <div class="filter-group">
              <label for="filterCategory">Filter by Category:</label>
              <select id="filterCategory" name="filterCategory">
                <option value="">All Categories</option>
                <% categories.forEach(function(cat){ %>
                  <option value="<%= cat %>" <%= filterCategory === cat ? 'selected' : '' %>><%= cat %></option>
                <% }); %>
              </select>
            </div>
            
            <div class="filter-group">
              <label for="stockThreshold">Filter by Stock below:</label>
              <input type="number" id="stockThreshold" name="stockThreshold" 
                    value="<%= typeof stockThreshold !== 'undefined' ? stockThreshold : '' %>" 
                    placeholder="Enter quantity threshold">
            </div>
            
            <button type="submit" class="filter-button">
              <i class="fas fa-filter"></i> Apply Filters
            </button>
          </div>
        </form>
      </div>
      
      <div class="page-header">
        <h1>Products List</h1>
      </div>
      
      <% if (products.length === 0) { %>
        <div class="empty-state">
          <i class="fas fa-box-open"></i>
          <p>No products available.</p>
        </div>
      <% } else { %>
        <div class="products-table-container">
          <table class="products-table">
            <thead>
              <tr>
                <th class="expand-column"></th>
                <th>Product Name</th>
                <th>Wholesale Price</th>
                <th>Retail Price</th>
                <th>Quantity</th>
                <th>Profit Margin</th>
                <th>Product ID</th>
                <th>Category</th>
              </tr>
            </thead>
            <tbody>
              <% products.forEach(function(product, index){ %>
                <!-- Main Product Row -->
                <tr class="product-row <%= product.quantity <= 10 ? 'low-stock' : '' %>">
                  <td class="expand-cell">
                    <% if (product.batches && product.batches.length > 0) { %>
                      <button class="expand-button" onclick="toggleBatches('<%= product.id %>')">
                        <i class="fas fa-chevron-down" id="icon-<%= product.id %>"></i>
                      </button>
                    <% } %>
                  </td>
                  <td class="product-name"><%= product.productName %></td>
                  <td class="price-cell"><span class="currency">$</span><%= product.wholesalePrice %></td>
                  <td class="price-cell"><span class="currency">$</span><%= product.retailPrice %></td>
                  <td class="quantity-cell <%= product.quantity <= 10 ? 'low-quantity' : '' %>">
                    <%= product.quantity %>
                    <% if (product.quantity <= 10) { %>
                      <span class="stock-badge">Low</span>
                    <% } %>
                  </td>
                  <td class="profit-cell"><%= product.profitMargin %><span class="percent">%</span></td>
                  <td><%= product.productId ? product.productId : '-' %></td>
                  <td class="category-cell"><span class="category-badge"><%= product.category ? product.category : '-' %></span></td>
                </tr>
                
                <!-- Batches Section -->
                <% if (product.batches && product.batches.length > 0) { %>
                <tr class="batches-container" id="batches-<%= product.id %>">
                  <td colspan="8" class="batches-cell">
                    <div class="batches-content">
                      <h4 class="batches-title">
                        <i class="fas fa-layer-group"></i>
                        Stock Batches for <%= product.productName %>
                      </h4>
                      <div class="batch-table-wrapper">
                        <table class="batch-table">
                          <thead>
                            <tr>
                              <th>Batch Date</th>
                              <th>Time Added</th>
                              <th>Purchase Price</th>
                              <th>Retail Price</th>
                              <th>Quantity</th>
                              <th>Remaining</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% product.batches.forEach(function(batch){ %>
                              <tr class="batch-row <%= batch.remainingQuantity === 0 ? 'empty-batch' : '' %>">
                                <td>
                                  <% 
                                    // Convert the batch date to a readable format.
                                    const batchDateObj = batch.batchDate && batch.batchDate.seconds 
                                      ? new Date(batch.batchDate.seconds * 1000) 
                                      : new Date(batch.batchDate);
                                  %>
                                  <%= batchDateObj.toLocaleDateString() %>
                                </td>
                                <td>
                                  <%= batchDateObj.toLocaleTimeString() %>
                                </td>
                                <td class="price-cell"><span class="currency">$</span><%= batch.purchasePrice.toFixed(2) %></td>
                                <td class="price-cell"><span class="currency">$</span><%= batch.salePrice.toFixed(2) %></td>
                                <td><%= batch.quantity %></td>
                                <td class="remaining-cell <%= batch.remainingQuantity === 0 ? 'empty' : '' %>">
                                  <%= batch.remainingQuantity %>
                                  <% if (batch.remainingQuantity === 0) { %>
                                    <span class="stock-badge empty">Empty</span>
                                  <% } %>
                                </td>
                                <td>
                                  <!-- Edit icon now placed in the batch row -->
                                  <a href="/edit-stock-batch/<%= batch.id %>" title="Edit this stock batch" class="edit-button">
                                    <i class="fas fa-edit"></i>
                                  </a>
                                  <% if (batch.remainingQuantity === 0) { %>
                                    <form action="/delete-stock-batch/<%= batch.id %>" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this stock batch?');">
                                      <button type="submit" class="delete-button">
                                        <i class="fas fa-trash"></i>
                                      </button>
                                    </form>
                                  <% } %>
                                </td>
                                
                              </tr>
                            <% }); %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
                <% } %>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>
  
  <!-- Toggle function for batches -->
  <script>
    function toggleBatches(id) {
      var batchesRow = document.getElementById('batches-' + id);
      var icon = document.getElementById('icon-' + id);
      
      if (batchesRow.classList.contains('show')) {
        batchesRow.classList.remove('show');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      } else {
        batchesRow.classList.add('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      }
    }
  </script>
  <script src="/js/firebasePersistence.js" type="module"></script>
</body>
</html>
